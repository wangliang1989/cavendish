步骤如下：

1. 读数并计算直接量的平均值
2. 计算直接量的不确定度
3. 正确表示直接量的结果
4. 计算间接量及其不确定度

# 1. 读数并计算直接量的平均值
读数时要注意正确保留有效数字（不是小数点位数）。
参照下表确定在读数时保留的有效数字位数（朱鹤年 $2003^{47}$ ）：

| 仪器类型     | 读法                                          |
| ------------ | ------------------------------------------- |
| 数显仪表     | 稳定数值加下一位不稳定的数值或者**四舍五入**到稳定数值    |
| 标刻度的仪器  | 最小分度值的几分之一，比如1/2、1/4、1/5、1/10     |
| 游标类       | 读到（游标）分度值的整数倍             |                                               |

多次读数完毕后，计算其算数平均数。
**算术平均数是在等精度测量的前提下的最佳值。在这之后，平均值要减去已定系统误差（如螺旋测微仪和游标卡尺的零点读数），并化为国际单位制。**

### 总结
以平均数为直接量的最佳估计值（要减出已定系统误差和化为国际单位制）。

```python
delta = 0.002
obs = (np.array([20.000, 19.990, 19.995, 20.005, 20.010]) - delta) / 1000 # 使用numpy数组会方便很多
mean = np.mean(obs)
```

# 2. 计算直接量的不确定度
**不确定度表征被测量的真值所处的量值范围的评定。**
**对某一量的表达方式为
$$X = \overline{x} \pm u,\ P= p$$
上式的含义是物理量 $X$ 的最佳估计值为 $\overline{x}$ ，它的误差在 $(-u,u)$ 之内的概率是 $p$ 。**
当要求的概率变化时，不确定度也会变化。
例如，要求置信概率为95%时的不确定度就会比68.5%时更大。
本课程要求一律使用95%的置信概率。

不确定度 $u(x)$ 的计算公式：
$$u(x)=\sqrt{u_A^2(x)+u_B^2(x)}$$
其中，$u_A(x)$ 、 $u_B(x)$ 是A、B类不确定度。
A类不确定度针对的是重复测量产生的、系统和（或）偶然误差。
B类不确定度针对的是每次测量产生的、系统和（或）偶然误差。

以下的不确定度的计算是展伸不确定度。

## A类不确定度
$u_A(x)$ 的计算公式：
$$u_A(x) = \frac{t}{\sqrt{n}}s(\overline{x})=\frac{t}{\sqrt{n}}\sqrt{\frac{\Sigma(x_i-\overline{x})^2}{n-1}}=\frac{t}{\sqrt{n}}\sqrt{\frac{\Sigma{x_i^2}-\frac{(\Sigma{x_i})^2}{n}}{n-1}}$$
其中， $x_i$ 是各个测量值。
$\overline{x}$ 是它们的平均数。
$n$ 是测量次数。
真值在一个不确定度内的范围的概率为0.95时， $\frac{t}{\sqrt{n}}$ 的值见下表：

| 测量次数$n$   | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 15 | 20 |
| -- | --- | -- | -- | --- | --- | --- | --- | --- | --- | --- | --- |
| $\frac{t}{\sqrt{n}}$ | 8.98 | 2.48 | 1.59 | 1.24 | 1.05 | 0.93 | 0.84 | 0.77 | 0.72 | 0.55 | 0.47 |

如果测量次数不是上述值，则使用下面的算式计算 $\frac{t}{\sqrt{n}}$  ：
$$\frac{1}{\sqrt{n}}(1.948 + \frac{2.835}{n - 1.735})$$
A类不确定度的上述计算基于如下数学理由：

1. 平均值的误差等于标准差除以 $\sqrt{n}$ ；只要能计算标准差，便能计算误差了。因为平均值不是真值，所以计算标准差要用样本标准差公式（也就是贝塞尔公式），而不能用总体标准差公式。（朱鹤年 $2003^{41}$ ）。
2. 为什么还要乘以 $t$ 因子？这就是展伸不确定度（或叫扩展不确定度）和标准不确定度的差异。物理实验中对某一个量的测量次数是较小的，是有限次的。这就造成实际情况和贝塞尔公式的推导的一些假设前提不同。依据著名的student分布，就要用上$t$因子。注意测量次数较少是其原因，但并不是说测量次数较少，每一次测量的误差就不是正态分布。（朱鹤年 $2003^{41}$ ）。
3. 为什么一般简单默认是正态分布？因为多个不同的独立分布（无论是否是正态分布）的和非常近似正态分布。即便单个分布不是正态分布，与正态分布的差异都是较小的。（朱鹤年 $2003^{40}$ ）。
4. 为什么上述计算的结果的概率是95%？这正是认为误差是正态分布的意义。正态分布在左右一个标准差内的概率为68.3%，左右两个标准差内的概率为95.4%。下表给出了在不同的概率下， $t$ 与 $n$ 的关系。在这个表中，如果测量次数为无穷大，一个标准差内的概率为68%。如果测量次数为无穷大，两个（1.95倍）标准差内的概率为95%。这些都是符合数理统计的基本知识的。下表为不同的测量次数和概率的 $t$ 值：

|          | $n=3$ | $n=4$ | $n=5$ | $n=6$ | $n=7$ | $n=8$ | $n=9$ | $n=10$ | $n=15$ | $n=20$ | $n=\infty$ |
| -------- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ------ | ------ | ------ | ---------- |
| $P=0.68$ |  1.32 |  1.20 |  1.14 |  1.11 |  1.09 |  1.08 |  1.07 |  1.06  |  1.04  |  1.03  |      1     |
| $P=0.90$ |  2.92 |  2.35 |  2.13 |  2.02 |  1.94 |  1.86 |  1.83 |  1.76  |  1.73  |  1.71  |      1.65  |
| $P=0.95$ |  4.30 |  3.18 |  2.78 |  2.57 |  2.46 |  2.37 |  2.31 |  2.26  |  2.15  |  2.09  |      1.96  |
| $P=0.99$ |  9.93 |  5.84 |  4.60 |  4.03 |  3.71 |  3.50 |  3.36 |  3.25  |  2.98  |  2.86  |      2.58  |

### 总结
计算A类扩展不确定度：先计算样本的标准差，再乘以 $\frac{t}{\sqrt{n}}$ （见下表）：

| $n$ | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 15 | 20 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| $\frac{t}{\sqrt{n}}$ | 8.98 | 2.48 | 1.59 | 1.24 | 1.05 | 0.93 | 0.84 | 0.77 | 0.72 | 0.55 | 0.47 |

```python
u_a = 1.24 * np.std(obs, ddof=1)#ddof参数为1，计算样本的标准差；没有这个参数，计算的是总体的标准差
print('A类扩展不确定度是', u_a)
```

如果不使用numpy：
```python
a = 0
for item in guance:
    a = a + (item - mean)**2
std_deviation = np.sqrt(a / (len(guance) - 1))
print('自己算算的样本标准差为：',a)
u_a = 1.24 * std_deviation
```
## B类不确定度
### 仪器误差
仪器误差记为 $\Delta_{仪}$ ，是在仪器制造过程符合质量标准时，仪器的可能的最大误差，也叫最大允差。仪器误差具有以下两条性质：
1. 仪器误差在 $(-\Delta_仪,\Delta_仪)$ 的概率一定为1。
2. 一般认为，仪器误差符合正态分布。

依据基本的概率论知识，在正态分布中，值位于3个正负标准差的范围之内的概率是99.7%。
因此，3个正负标准差的范围就可以认为和 $(-\Delta_仪,\Delta_仪)$ 的概率相同了。
所以标准差就等于 $\frac{\Delta_仪}{3}$ 。
这个比值3叫做置信系数。

仪器误差的标准差是不能直接计算的，它是所有同型号仪器**的**误差的正态分布的标准差。可达成如下结论：
1. 任何一台仪器的误差在 $(-\Delta_仪,\Delta_仪)$ 的概率为1
2. 任何一台仪器的误差在 $(-\frac{\Delta_仪}{3},\frac{\Delta_仪}{3})$ 的概率和在一个标准差的范围相同，概率为68.3%。

我们需要的概率通常是95%。
这样就需要再乘以一个置信因子 $k_p$ 才能得到概率为95%的范围。
置信系数和置信因子随分布的不同而不同：

| 仪器名称    | 秒表     | 物理天平 | 米尺     | 千分尺   | 游标卡尺 |
| ----------- | -------- | -------- | -------- | -------- | -------- |
| 误差分布     | 正态分布 | 正态分布 | 正态分布 | 正态分布 | 均匀分布 |
| 置信系数 $C$ | 3        | 3        | 3        | 3        | $\sqrt3$ |
| 95%概率的置信因子 $k_p$ | 1.960 | 1.960 | 1.960 | 1.960 | 1.645 |

### 估读误差
估读误差是指在估读的时候，估读不准确引入的误差。
不同仪器的估读误差参照下表：

|        | 游标类 | 标刻度的仪器  | 数显仪表（无不稳定数值） |  秒表   |
| ------ | ----- | ----------- | -------------------- | ------ |
| 估读误差 | 0    | 最小分度的一半 |              0       | $0.2s$ |

### B类不确定度的计算
因为仪器误差和估读误差是相互独立的，所以B类不确定度 $u_B$ 有
$$u_B=k_p\frac{\Delta}{C}$$
其中 $\Delta=\sqrt{\Delta_{仪}^2+\Delta_{估}^2}$

### 总结

$$u_B=k_p\frac{\sqrt{\Delta_{仪}^2+\Delta_{估}^2}}{C}$$
不同仪器的仪器误差 $\Delta_{仪}$ 不同。
估读误差 $\Delta_{估}$ 见下表：

| 仪器名称 | 游标类 |  标刻度的仪器  | 数显仪表（无不稳定数值） | 秒表   |
| ------- | ----- | ------------ | ------------------- | ------ |
| 估读误差 |    0  | 最小分度的一半 |            0         | 0.2 s |

置信系数 $C$ 和95%概率的置信因子 $k_p$ 见下表：

|       仪器名称        | 秒表     | 物理天平 | 米尺     | 千分尺   | 游标卡尺 |
| -------------------- | ------- | ------- | ------- | ------- | -------- |
|       误差分布        | 正态分布  | 正态分布 | 正态分布 | 正态分布 | 均匀分布 |
|      置信系数 $C$      | 3       | 3       | 3       | 3       | $\sqrt3$ |
| 95%概率的置信因子 $k_p$ | 1.960   | 1.960   | 1.960   | 1.960   | 1.645 |
```python
u_yiqi = 0.004 / 1000
u_gudu = 0.005 / 1000
c = 3
k = 1.96
u_B = np.sqrt(u_yiqi**2 + u_gudu**2) / c * k
print('B类不确定度是', u_B)
```
# 3. 正确表示直接量的结果
要完成这一步，首先要修约。

### 修约
数字可能有很长的位数，例如3.145926...。修约是将这个数字中一定数位以后的数省略掉，例如3.145926...变为3.14。

修约步骤如下：
1. 确定位数：**如果首位有效数字为1或2，则保留两位有效数字，否则保留一位有效数字。**
2. 考虑是否在不确定度的最后一位数上加1：四舍六入，逢五配双（拟舍弃的数字的第一、二位分别是5、0，则配双。否则按照习惯的四舍五入来）（朱鹤年 $2003^{48}$ ）。

假设要保留三位小数点，应用“四舍六入，逢五配双“的例子：

- 拟舍弃的数字最左一位小于5，则舍弃： $4.32749 \rightarrow 4.327$
- 拟舍弃的数字最左一位大于5，则进位： $4.32769 \rightarrow 4.328$
- 拟舍弃的数字最左一位是5，第二位不是0，则进位： $4.32651 \rightarrow 4.327$
- 拟舍弃的数字最左一位是5，第二位是0，则配双： $4.32750 \rightarrow 4.328$ ， $4.32850 \rightarrow 4.328$

**这种修约规则的标准其实是拟舍弃的数字如果大于修约间隔的一半就在舍弃后进位，如果更小，就只舍弃，而不进位。如果刚好相等，考虑配偶。**

### 依据不确定度对直接观测量修约
**直接观测量的小数点位数（不是有效数字）与完成修约后的不确定度相同，以得到自洽结果。**
具体做法依然是四舍六入，逢五配双。
至此，才得到了直接观测量及其不确定度的正式结果。
本课程的结果必须表示为如下形式：

$X = \overline{x} \pm u$, $P=0.95$

### 总结

修约：
1. 如果不确定度的首位有效数字为1或2，则保留两位有效数字，否则保留一位有效数字。拟舍弃的数字的第一、二位分别是5、0，则配双。否则按照习惯的四舍五入来。
2. 直接量的小数点位数和不确定度一致。

# 4. 间接量及其不确定度

通常得出间接量是用间接量与直接量的物理公式，但也有些不是。
不是的情况是要应用一些数值方法，后续会介绍。
此处只介绍使用间接量与直接量的物理公式的情况。
## 计算间接量
**依据上面的间接观测量的正式结果及其与直接观测量之间的物理公式计算。**

## 计算间接观测量的不确定度
首先，计算间接、直接观测量之间的偏微分。然后，依据不确定度传递公式计算间接观测量的不确定度（ $u_{X_k} $是相应直接观测量的不确定度）：

$$U_Y=\sqrt{\Sigma[\frac{\partial{f(X_k)}}{\partial{X_k}}u_{X_k}]^2}$$

计算物理公式的不确定度传递公式**不是**易事，不妨尝试用下面的流程计算：

1. 对函数求全微分或（若含乘除关系）先取对数再求微分
2. 合并同类项
3. 将微分符号改成不确定度符号
4. 各项平方和（或简化为绝对值的和）

最后，计算得到的不确定度需要修约。
做法与上面的直接观测量的不确定度一样。
如果首位有效数字为1或2，则保留两位有效数字，否则保留一位有效数字。
否则保留两位。修约时，四舍六入，逢五配双。

### 推导误差传递公式的例子
$$\rho=\frac{m}{m-m_1}\rho$$

两边取对数

$$\ln\rho = \ln m + \ln \rho_0 - \ln(m-m_1)$$
求全微分

$$\frac{{\rm d}\rho}{\rho} = \frac{{\rm d}m}{m} + \frac{{\rm d}\rho_0}{\rho_0} -\frac{{\rm d}(m-m_1)}{m-m_1}$$
$$\frac{{\rm d}\rho}{\rho} = \frac{{\rm d}m}{m} + \frac{{\rm d}\rho_0}{\rho_0} -\frac{{\rm d}m}{m-m_1}+\frac{{\rm d}m_1}{m-m_1}$$

合并同类项

$$\frac{{\rm d}\rho}{\rho} = \frac{-m_1{\rm d}m}{m(m-m_1)} + \frac{{\rm d}\rho_0}{\rho_0} + \frac{{\rm d}m_1}{m-m_1}$$

将微分符号改成不确定度符号

$$\frac{u_\rho}{\rho} = \frac{-m_1u_m}{m(m-m_1)} + \frac{u(\rho_0)}{\rho_0} + \frac{u_{m_1}}{m-m_1}$$

各项平方和：

$$\frac{u_\rho}{\rho} = \sqrt{[\frac{-m_1}{m(m-m_1)}]^2u_{m}^2 + \frac{u^2(\rho_0)}{{\rho_0}^2} + [\frac{1}{m-m_1}]^2u_{m_1}^2}$$

## 对间接观测量修约
间接观测量也需要修约，其小数点位数（不是有效数字位数）与其不确定度的小数点位数一致。

## 总结

1. 用物理公式计算间接量
2. 用误差传递公式计算间接量的不确定度
3. 对间接量的不确定度和间接量进行修约
